<?xml version='1.0' encoding='UTF-8'?>
<xwikidoc version="1.2" reference="RegistruAuto.Code.Macros.WebHome" locale="">
  <web>RegistruAuto.Code.Macros</web>
  <name>WebHome</name>
  <language/>
  <defaultLanguage>en</defaultLanguage>
  <translation>0</translation>
  <creator>XWiki.alex</creator>
  <creationDate>1474114281000</creationDate>
  <parent>RegistruAuto.Code.WebHome</parent>
  <author>XWiki.alex</author>
  <contentAuthor>XWiki.alex</contentAuthor>
  <date>1478584913000</date>
  <contentUpdateDate>1478584913000</contentUpdateDate>
  <version>1.85</version>
  <title>Macros</title>
  <comment/>
  <minorEdit>true</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity}}&#xd;
#set ($sections = {&#xd;
  'SFR': 'Sofer',&#xd;
  'ROV': 'Rovinieta',&#xd;
  'ASG': 'Asigurare',&#xd;
  'ITP': 'ITP',&#xd;
  'THG': 'Tahograf',&#xd;
  'CCF': 'CopieConforma'&#xd;
})&#xd;
#set ($today = $xwiki.jodatime.getDateTime().withTimeAtStartOfDay())&#xd;
#macro (getTodayExpirationFees)&#xd;
  #set ($nothingExpiringToday = true)&#xd;
  #foreach ($section in $sections.entrySet())&#xd;
    #set ($sectionClassName = "RegistruAuto.${section.value}.Code.${section.value}Class")&#xd;
    #set ($query = "from doc.object(${sectionClassName}) as section where doc.object(${sectionClassName}).dataExpirare = :endDate")&#xd;
    #set ($results = $services.query.xwql($query).bindValue('endDate', $today.toDate()).execute())&#xd;
    #if ($results.size() > 0)&#xd;
      #set ($nothingExpiringToday = false)&#xd;
      (%class="expiraMaine"%)(((&#xd;
        ==== $services.localization.render("auto.section${section.value}") ====&#xd;
        #foreach ($result in $results)&#xd;
          #set ($sectionDoc = $xwiki.getDocument($result))##&#xd;
          #set ($autoDoc = $xwiki.getDocument($sectionDoc.parent))##&#xd;
          [[${section.key}_$autoDoc.plainTitle>>$autoDoc]]&#xd;
        #end&#xd;
      )))&#xd;
    #end&#xd;
  #end&#xd;
#end&#xd;
&#xd;
#macro (getExpiredFees)&#xd;
  #set ($fields = {&#xd;
    'autocamion'    : ['Asigurare', 'ITP', 'CopieConforma', 'Rovinieta', 'Tahograf'],&#xd;
    'autoturism'    : ['Asigurare', 'ITP', 'Rovinieta'],&#xd;
    'autoutilitara' : ['Asigurare', 'ITP', 'Rovinieta'],&#xd;
    'semiremorca'   : ['Asigurare', 'ITP']&#xd;
    })&#xd;
  #set ($autoClass = 'RegistruAuto.Auto.Code.AutoClass')&#xd;
  #set ($query = "from doc.object($autoClass) as auto where auto.activ=1 order by auto.numarInmatriculare")&#xd;
  #set ($results = $services.query.xwql($query).execute())&#xd;
  #set ($nothingExpired = true)&#xd;
  #if ($results.size() > 0)&#xd;
    #set ($nothingExpired = false)&#xd;
    (%class="politeExpirate"%)(((&#xd;
      #foreach ($result in $results)&#xd;
        #set ($resultDoc = $xwiki.getDocument($result))&#xd;
        #set ($resultObj = $resultDoc.getObject($autoClass))&#xd;
        #foreach ($field in $fields.get($resultObj.getValue('categorie')))&#xd;
          #set ($dataExpirareField = "dataExpirare${field}")&#xd;
          #if ("$!{resultObj.getValue($dataExpirareField)}" != '')&#xd;
            #if ($today.compareTo($xwiki.jodatime.getDateTime($resultObj.getValue("${dataExpirareField}").time)) > 0)&#xd;
              [[$resultDoc.plainTitle>>$resultDoc]] : $field&#xd;
            #end&#xd;
          #else&#xd;
            [[$resultDoc.plainTitle>>$resultDoc]] : $field&#xd;
          #end&#xd;
        #end&#xd;
      #end&#xd;
    )))&#xd;
  #end&#xd;
&#xd;
  ## #set ($nothingExpired = true)&#xd;
  ## #foreach ($section in $sections.entrySet())&#xd;
  ##   #set ($sectionClassName = "RegistruAuto.${section.value}.Code.${section.value}Class")&#xd;
  ##   #set ($query = "from doc.object(${sectionClassName}) as section where section.dataExpirare &lt; :startDate")&#xd;
  ##   #set ($results = $services.query.xwql($query).bindValue('startDate', $startDate.toDate()).execute())&#xd;
  ##   #if ($results.size() > 0)&#xd;
  ##     #set ($nothingExpired = false)&#xd;
  ##     (%class="politeExpirate"%)(((&#xd;
  ##       ==== $services.localization.render("auto.section${section.value}") ====&#xd;
  ##       #foreach ($result in $results)&#xd;
  ##         #set ($sectionDoc = $xwiki.getDocument($result))##&#xd;
  ##         #set ($autoDoc = $xwiki.getDocument($sectionDoc.parent))##&#xd;
  ##         [[$autoDoc.plainTitle>>$autoDoc]]&#xd;
  ##       #end&#xd;
  ##     )))&#xd;
  ##   #end&#xd;
  ## #end&#xd;
#end{{/velocity}}&#xd;
 </content>
</xwikidoc>